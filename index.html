<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø³ÙˆØ±ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ - Unified Syrian Accounting System">
    <meta name="theme-color" content="#2ecc71">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ø°ÙƒÙŠ">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
    <link rel="apple-touch-icon" href="./icon-192.png">
    <title>Smart Accountant Pro - DR.HAIDAR ALBUNNI</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #2ecc71; --dark: #27ae60; --bg: #f5f6fa;
            --card: #ffffff; --text: #2f3640; --border: #dcdde1;
            --danger: #e74c3c; --warning: #f39c12;
        }
        [data-theme="dark"] {
            --bg: #1e272e; --card: #2f3640; --text: #f5f6fa; --border: #485460;
        }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; transition: 0.3s; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 10px; min-height: 100vh; }
      
        .app-container { max-width: 480px; margin: 0 auto; background: var(--card); border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; position: relative; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(0,0,0,0.05); }
        .btn-lang { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 10px; cursor: pointer; font-weight: 800; font-size: 12px; }

        .header { background: linear-gradient(135deg, var(--primary), var(--dark)); color: white; padding: 30px; text-align: center; position: relative; }
        .header h1 { margin: 0; font-size: 19px; font-weight: 800; display: inline-block; }
        .live-badge { display: inline-block; width: 10px; height: 10px; background: #fff; border-radius: 50%; margin-right: 8px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        .tabs-menu { display: flex; padding: 10px; background: var(--bg); margin: 15px; border-radius: 15px; gap: 5px; }
        .tab-link { flex: 1; padding: 12px 5px; border: none; background: transparent; cursor: pointer; color: #7f8c8d; font-weight: 800; font-size: 11px; border-radius: 10px; }
        .tab-link.active { background: var(--primary); color: white; }

        .tab-content { display: none; padding: 0 20px 25px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .title-sec { font-size: 13px; font-weight: 800; color: var(--primary); margin: 15px 0 10px; border-right: 4px solid var(--primary); padding-right: 8px; }
        [dir="ltr"] .title-sec { border-right: none; border-left: 4px solid var(--primary); padding-left: 8px; }

        label { font-size: 11px; font-weight: 800; margin-bottom: 5px; display: block; opacity: 0.9; }
        input, select { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-weight: 800; outline: none; }
        input:disabled { opacity: 0.4; }
      
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; background: var(--primary); color: white; font-size: 15px; margin-top: 10px; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); }
        .inline-result { margin-top: 15px; padding: 15px; border-radius: 15px; background: rgba(46, 204, 113, 0.1); border: 2px dashed var(--primary); text-align: center; display: none; }

        .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 9999; padding: 20px; }
        .modal-body { background: var(--card); border-radius: 30px; width: 100%; max-width: 380px; padding: 40px 25px; text-align: center; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.4); }
        .modal-body p { font-size: 18px; font-weight: 700; line-height: 1.6; white-space: pre-line; margin-bottom: 25px; }

        .table-wrap { max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: 15px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th { background: var(--bg); padding: 12px; position: sticky; top: 0; border-bottom: 2px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); text-align: center; }

        .footer-info { margin-top: 25px; padding: 30px 20px; background: rgba(0,0,0,0.03); text-align: center; border-top: 1px solid var(--border); }
        .dev-card { background: var(--card); padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .dev-name { font-size: 16px; font-weight: 800; color: var(--primary); margin-bottom: 10px; display: block; }
        .dev-links a { text-decoration: none; color: var(--text); font-size: 12px; font-weight: 700; margin: 0 10px; }
        .fab-theme { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: #34495e; color: white; border: none; cursor: pointer; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* --- Activation System --- */
        #activation-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(25px); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .activation-card { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 30px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.4); border: 1px solid #fff; }
        .device-id-box { background: #f1f2f6; padding: 12px; border-radius: 10px; font-family: monospace; font-size: 13px; margin: 15px 0; border: 1px dashed var(--primary); color: #2f3640; user-select: all; cursor: pointer; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

        @media print { .tabs-menu, .top-bar, .fab-theme, .btn-main, .footer-info, .inline-result { display: none !important; } .app-container { border:none; box-shadow:none; } }
    </style>
</head>
<body dir="rtl">

<button class="fab-theme" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>

<div id="activation-layer" style="display:none;">
    <div class="activation-card" id="actCard">
        <i class="fas fa-shield-check" style="font-size: 50px; color: var(--primary); margin-bottom: 15px;"></i>
        <h2 style="margin:0; font-weight: 800;">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø¨Ø±Ùˆ</h2>
        <p style="font-size: 13px; color: #666; margin-top: 10px;">Ø§Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©:</p>
        <div class="device-id-box" id="displayDeviceID" onclick="copyDID()"></div>
        <input type="text" id="activationKeyInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù‡Ù†Ø§..." style="text-align:center; letter-spacing: 2px;">
        <button class="btn-main" onclick="validateActivation()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¢Ù†</button>
        <p style="font-size: 11px; margin-top: 20px; opacity: 0.5;">DR. HAIDAR ALBUNNI Â© 2026</p>
    </div>
</div>

<div id="modalOverlay" class="modal-wrap">
    <div class="modal-body">
        <i id="mIcon" style="font-size: 60px; margin-bottom: 20px; display: block;"></i>
        <h2 id="mTitle"></h2>
        <p id="mMsg"></p>
        <div id="modalActions"><button class="btn-main" onclick="closeModal()">Ù…ÙˆØ§ÙÙ‚ / OK</button></div>
    </div>
</div>

<div class="app-container" id="mainApp" style="display:none;">
    <div class="top-bar">
        <span style="font-weight: 800;" id="brand">Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ø°ÙƒÙŠ</span>
        <button class="btn-lang" id="langBtn" onclick="toggleLang()">English</button>
    </div>

    <div class="header">
        <div class="live-badge"></div>
        <h1 id="hTitle">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø³ÙˆØ±ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯</h1>
    </div>

    <nav class="tabs-menu">
        <button class="tab-link active" id="t-calc" onclick="openTab('calc')">Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        <button class="tab-link" id="t-box" onclick="openTab('box')">Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</button>
        <button class="tab-link" id="t-conv" onclick="openTab('conv')">Ø§Ù„Ø¹Ù…Ù„Ø§Øª</button>
        <button class="tab-link" id="t-log" onclick="openTab('log')">Ø§Ù„Ø³Ø¬Ù„</button>
    </nav>

    <div id="tab-calc" class="tab-content active">
        <div class="title-sec" id="s-price">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</div>
        <div style="display: flex; gap: 8px;">
            <div style="flex:1"><label id="l-n1">Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© SYP</label><input type="number" id="pN" oninput="checkInputs()"></div>
            <div style="flex:1"><label id="l-o1">Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø© SYP</label><input type="number" id="pO" oninput="checkInputs()"></div>
        </div>
        <div class="title-sec" id="s-paid">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…</div>
        <div style="display: flex; gap: 8px;">
            <div style="flex:1"><label id="l-n2">Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© SYP</label><input type="number" id="payN"></div>
            <div style="flex:1"><label id="l-o2">Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø© SYP</label><input type="number" id="payO"></div>
        </div>
        <button class="btn-main" onclick="runCalc()" id="btn-run">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
    </div>

    <div id="tab-box" class="tab-content">
        <div class="title-sec" id="s-box">Ø¬Ø±Ø¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
        <div style="margin-bottom:10px">
            <label id="lb-n">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© SYP</label>
            <input type="number" id="boxN">
        </div>
        <div>
            <label id="lb-o">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© SYP</label>
            <input type="number" id="boxO">
        </div>
        <button class="btn-main" onclick="runBox()" id="btn-box">Ø¹Ø±Ø¶ ÙˆØ­ÙØ¸ Ø§Ù„Ø¬Ø±Ø¯</button>
        <div id="res-box" class="inline-result"></div>
    </div>

    <div id="tab-conv" class="tab-content">
        <div class="title-sec" id="s-conv">Ù…Ø­ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª</div>
        <p style="font-size:10px; opacity:0.7; margin-bottom:10px" id="i-conv">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø© ÙˆØ§Ù„Ù…Ø¨Ù„Øº ÙˆØ³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø¨Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p>
        <select id="curType" style="margin-bottom:10px">
            <option value="USD">USD ($)</option><option value="EUR">EUR (â‚¬)</option><option value="TRY">TRY (â‚º)</option>
        </select>
        <input type="number" id="curAmt" placeholder="0.00" oninput="liveUpdate()">
        <input type="number" id="curRate" placeholder="Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø¨Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" oninput="liveUpdate()" style="margin-top:10px">
        <div id="res-conv" class="inline-result" style="display:block">0.00 SYP</div>
    </div>

    <div id="tab-log" class="tab-content">
        <div class="title-sec" id="s-log">Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
        <div class="table-wrap">
            <table id="logTable">
                <thead><tr><th id="th-t">Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th><th id="th-v">Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th id="th-r">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="display: flex; gap: 8px; margin-top: 15px;">
            <button id="btn-print" class="btn-main" style="background:#34495e; font-size:12px;" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
            <button id="btn-excel" class="btn-main" style="background:#f39c12; color:black; font-size:12px;" onclick="exportCSV()">ØªØµØ¯ÙŠØ± Excel</button>
        </div>
        <button class="btn-main" style="background:var(--danger)" onclick="confirmClear()" id="btn-clr">ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„</button>
    </div>

    <div class="footer-info">
        <div class="dev-card">
            <span class="dev-name">DR.HAIDAR ALBUNNI</span>
            <div class="dev-links">
                <a href="https://wa.me/963991365308" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                <a href="mailto:haidaralbunni@gmail.com"><i class="fas fa-envelope"></i> Email</a>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    // Anti-debugging protection
    (function() {
        const _0xcheck = function() {
            const _0xstart = performance.now();
            debugger;
            const _0xend = performance.now();
            if (_0xend - _0xstart > 100) {
                while(true) {
                    debugger;
                }
            }
        };
        setInterval(_0xcheck, 4000);
    })();

    (function() {
        const _0xdevtools = /./;
        _0xdevtools.toString = function() {
            this.opened = true;
        };
        const _0xcheck = setInterval(function() {
            if (_0xdevtools.opened) {
                window.location.reload();
            }
        }, 1000);
    })();

    // Anti-tampering protection (Refined to avoid infinite reload)
    (function() {
        let _0xoriginalHash = document.body.innerHTML.length;
        setInterval(function() {
            const currentHash = document.body.innerHTML.length;
            // Allow small changes (like SweetAlert modals) but reload on major DOM manipulation
            if (Math.abs(currentHash - _0xoriginalHash) > 1500) {
                location.reload();
            }
        }, 3000);
    })();

    // Core application logic (preserved 100%)
    let db = JSON.parse(localStorage.getItem('SYP_V24_MASTER')) || [];
    let currentLang = 'ar';
    const SECRET_SALT = "HAIDAR_PRO_2026_V24";

    const lang = {
        ar: {
            lang: 'English', brand: 'Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ø°ÙƒÙŠ', hTitle: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø³ÙˆØ±ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯',
            tCalc: 'Ø§Ù„Ø­Ø³Ø§Ø¨', tBox: 'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚', tConv: 'Ø§Ù„Ø¹Ù…Ù„Ø§Øª', tLog: 'Ø§Ù„Ø³Ø¬Ù„',
            sPrice: 'Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬', sPaid: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù…', btnRun: 'Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©',
            sBox: 'Ø¬Ø±Ø¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø§Ù„ÙŠ', lbN: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© SYP', lbO: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© SYP', btnBox: 'Ø¹Ø±Ø¶ ÙˆØ­ÙØ¸ Ø§Ù„Ø¬Ø±Ø¯',
            sConv: 'Ù…Ø­ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª', iConv: 'Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø© ÙˆØ§Ù„Ù…Ø¨Ù„Øº ÙˆØ³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø¨Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©', ratePh: 'Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø¨Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
            sLog: 'Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±', btnClr: 'ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„', thT: 'Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª', thV: 'Ø§Ù„Ù‚ÙŠÙ…Ø©', thR: 'Ø§Ù„Ù†ØªÙŠØ¬Ø©',
            mB: 'Ø¨Ø§Ù‚ÙŠ Ù„Ù„Ø²Ø¨ÙˆÙ†', mN: 'Ù†Ù‚Øµ Ù…Ù† Ø§Ù„Ø²Ø¨ÙˆÙ†', mE: 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙƒØªÙ…Ù„', errE: 'âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± Ø£ÙˆÙ„Ø§Ù‹!',
            conf: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„ØŸ', new: 'Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© SYP', old: 'Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø© SYP',
            print: 'Ø·Ø¨Ø§Ø¹Ø©', excel: 'ØªØµØ¯ÙŠØ± Excel'
        },
        en: {
            lang: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', brand: 'Smart Accountant', hTitle: 'Unified SYP System',
            tCalc: 'Calc', tBox: 'Vault', tConv: 'Rates', tLog: 'Log',
            sPrice: 'Product Price', sPaid: 'Amount Paid', btnRun: 'Calculate',
            sBox: 'Vault Inventory', lbN: 'Total New SYP', lbO: 'Total Old SYP', btnBox: 'Show & Save',
            sConv: 'Currency Converter', iConv: 'Select currency, amount & rate in New SYP', ratePh: 'Exchange rate in New SYP',
            sLog: 'Reports Log', btnClr: 'Clear All Log', thT: 'Date & Time', thV: 'Value', thR: 'Result',
            mB: 'Change for Customer', mN: 'Shortage detected', mE: 'Paid in Full', errE: 'âš ï¸ Enter price first!',
            conf: 'Are you sure you want to clear the log?', new: 'New SYP', old: 'Old SYP',
            print: 'Print', excel: 'Export Excel'
        }
    };

    // Secure device ID generator (non-persistent, session-based)
    function generateDeviceID() {
        const _0xarray = new Uint8Array(16);
        crypto.getRandomValues(_0xarray);
        const _0xhex = Array.from(_0xarray, b => b.toString(16).padStart(2, '0')).join('');
        return "HAIDAR-" + _0xhex.substring(0, 12).toUpperCase();
    }

    function getValidKey(did) {
        let hash = 0; const input = did + SECRET_SALT;
        for (let i = 0; i < input.length; i++) { hash = ((hash << 5) - hash) + input.charCodeAt(i); hash |= 0; }
        return "ACT-" + Math.abs(hash).toString(16).toUpperCase() + "-" + (did.length * 777);
    }

    function validateActivation() {
        const inputKey = document.getElementById('activationKeyInput').value.trim();
        const did = document.getElementById('displayDeviceID').innerText;
        if (inputKey === getValidKey(did)) {
            localStorage.setItem('SYP_ACTIVATED_TOKEN', btoa('ACTIVE_' + did));
            Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', text: 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø¯ÙƒØªÙˆØ± Ø­ÙŠØ¯Ø±', timer: 2000, showConfirmButton: false }).then(() => {
                // Clear state before reload to avoid anti-tamper trigger
                document.body.innerHTML = "<h1>Loading...</h1>";
                location.reload();
            });
        } else {
            document.getElementById('actCard').classList.add('shake');
            setTimeout(() => document.getElementById('actCard').classList.remove('shake'), 500);
            Swal.fire({ icon: 'error', title: 'ÙØ´Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„', text: 'Ø±Ù…Ø² Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­! ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.', confirmButtonColor: '#2ecc71' });
        }
    }

    function checkStatus() {
        const did = generateDeviceID();
        document.getElementById('displayDeviceID').innerText = did;
        
        const storedToken = localStorage.getItem('SYP_ACTIVATED_TOKEN');
        if (storedToken) {
            try {
                const decoded = atob(storedToken);
                if (decoded.startsWith('ACTIVE_HAIDAR-')) {
                    document.getElementById('mainApp').style.display = 'block';
                    const layer = document.getElementById('activation-layer');
                    if (layer) layer.remove();
                    return;
                }
            } catch(e) {}
        }
        
        document.getElementById('activation-layer').style.display = 'flex';
        setupAntiTamper();
    }

    function setupAntiTamper() {
        const obs = new MutationObserver((mutations) => { 
            for (let mutation of mutations) {
                if (mutation.removedNodes) {
                    for (let node of mutation.removedNodes) {
                        if (node.id === 'activation-layer') {
                            // Only reload if not activated
                            if (!localStorage.getItem('SYP_ACTIVATED_TOKEN')) {
                                location.reload();
                            }
                        }
                    }
                }
            }
        });
        obs.observe(document.body, { childList: true });
    }

    function copyDID() {
        const did = document.getElementById('displayDeviceID').innerText;
        navigator.clipboard.writeText(did);
        Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'ØªÙ… Ø§Ù„Ù†Ø³Ø®', showConfirmButton: false, timer: 1000 });
    }

    // Original application logic (100% preserved)
    function toggleLang() {
        currentLang = currentLang === 'ar' ? 'en' : 'ar';
        const d = lang[currentLang];
        document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
        document.getElementById('langBtn').innerText = d.lang;
        document.getElementById('brand').innerText = d.brand;
        document.getElementById('hTitle').innerText = d.hTitle;
        document.getElementById('t-calc').innerText = d.tCalc;
        document.getElementById('t-box').innerText = d.tBox;
        document.getElementById('t-conv').innerText = d.tConv;
        document.getElementById('t-log').innerText = d.tLog;
        document.getElementById('s-price').innerText = d.sPrice;
        document.getElementById('s-paid').innerText = d.sPaid;
        document.getElementById('btn-run').innerText = d.btnRun;
        document.getElementById('s-box').innerText = d.sBox;
        document.getElementById('lb-n').innerText = d.lbN;
        document.getElementById('lb-o').innerText = d.lbO;
        document.getElementById('btn-box').innerText = d.btnBox;
        document.getElementById('s-conv').innerText = d.sConv;
        document.getElementById('i-conv').innerText = d.iConv;
        document.getElementById('s-log').innerText = d.sLog;
        document.getElementById('btn-clr').innerText = d.btnClr;
        document.getElementById('btn-print').innerText = d.print;
        document.getElementById('btn-excel').innerText = d.excel;
        document.getElementById('curRate').placeholder = d.ratePh;
        document.getElementById('th-t').innerText = d.thT;
        document.getElementById('th-v').innerText = d.thV;
        document.getElementById('th-r').innerText = d.thR;
        document.getElementById('l-n1').innerText = d.new; document.getElementById('l-o1').innerText = d.old;
        document.getElementById('l-n2').innerText = d.new; document.getElementById('l-o2').innerText = d.old;
        updateLog(); liveUpdate();
    }

    function checkInputs() {
        const pn = document.getElementById('pN'), po = document.getElementById('pO');
        pn.value !== "" ? po.disabled = true : po.disabled = false;
        po.value !== "" ? pn.disabled = true : pn.disabled = false;
    }

    function openTab(id) {
        document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('t-'+id).classList.add('active');
        document.getElementById('tab-'+id).classList.add('active');
    }

    function toggleTheme() {
        const isDark = document.body.hasAttribute('data-theme');
        isDark ? document.body.removeAttribute('data-theme') : document.body.setAttribute('data-theme', 'dark');
        document.querySelector('.fab-theme i').className = isDark ? 'fas fa-moon' : 'fas fa-sun';
    }

    function showModal(icon, title, msg, color, cancel = false) {
        document.getElementById('mIcon').className = icon;
        document.getElementById('mIcon').style.color = color;
        document.getElementById('mTitle').innerText = title;
        document.getElementById('mMsg').innerText = msg;
        document.getElementById('modalOverlay').style.display = 'flex';
        const actions = document.getElementById('modalActions');
        actions.innerHTML = `<button class="btn-main" onclick="closeModal()">Ù…ÙˆØ§ÙÙ‚ / OK</button>`;
        if(cancel) actions.innerHTML += `<button class="btn-main" style="background:#7f8c8d; margin-top:5px" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>`;
    }
    
    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

    function runCalc() {
        const pn = parseFloat(document.getElementById('pN').value) || 0;
        const po = parseFloat(document.getElementById('pO').value) || 0;
        const payN = parseFloat(document.getElementById('payN').value) || 0;
        const payO = parseFloat(document.getElementById('payO').value) || 0;
        const d = lang[currentLang];
        if(pn === 0 && po === 0) { showModal('fas fa-exclamation-triangle', '!', d.errE, 'var(--warning)'); return; }
        const price = pn > 0 ? pn : po / 100;
        const paid = payN + (payO / 100);
        const diff = paid - price;
        const absV = Math.abs(diff);
        const resTxt = `${absV.toFixed(2)} (${currentLang === 'ar' ? 'Ø¬Ø¯ÙŠØ¯' : 'NEW'})\n${Math.round(absV*100).toLocaleString()} (${currentLang === 'ar' ? 'Ù‚Ø¯ÙŠÙ…' : 'OLD'})`;
        if (diff > 0) showModal('fas fa-plus-circle', d.mB, resTxt, 'var(--primary)');
        else if (diff < 0) showModal('fas fa-minus-circle', d.mN, resTxt, 'var(--danger)');
        else showModal('fas fa-check-double', d.mE, '', 'var(--primary)');
        saveLog(price.toFixed(2), diff.toFixed(2));
    }

    function runBox() {
        const val = (parseFloat(document.getElementById('boxN').value)||0) + ((parseFloat(document.getElementById('boxO').value)||0)/100);
        document.getElementById('res-box').style.display = 'block';
        document.getElementById('res-box').innerHTML = `<strong>${val.toFixed(2)} (${currentLang === 'ar' ? 'Ø¬Ø¯ÙŠØ¯' : 'NEW'})</strong><br><small>${Math.round(val*100).toLocaleString()} (${currentLang === 'ar' ? 'Ù‚Ø¯ÙŠÙ…' : 'OLD'})</small>`;
        saveLog(val.toFixed(2), "ğŸ“¦ VAULT");
    }

    function liveUpdate() {
        const res = (parseFloat(document.getElementById('curAmt').value)||0) * (parseFloat(document.getElementById('curRate').value)||0);
        document.getElementById('res-conv').innerHTML = `<strong>${res.toFixed(2)} (${currentLang === 'ar' ? 'Ø¬Ø¯ÙŠØ¯' : 'NEW'})</strong><br><small>${Math.round(res*100).toLocaleString()} (${currentLang === 'ar' ? 'Ù‚Ø¯ÙŠÙ…' : 'OLD'})</small>`;
    }

    function saveLog(val, res) {
        const now = new Date();
        const dateStr = `${now.getDate()}/${now.getMonth()+1} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        db.push({ t: dateStr, v: val, r: res });
        localStorage.setItem('SYP_V24_MASTER', JSON.stringify(db));
        updateLog();
    }

    function updateLog() {
        const tbody = document.querySelector('#logTable tbody');
        if(!tbody) return;
        tbody.innerHTML = '';
        [...db].reverse().slice(0, 50).forEach(e => {
            const isV = e.r === "ğŸ“¦ VAULT";
            const color = isV ? 'var(--warning)' : (e.r < 0 ? 'var(--danger)' : 'var(--primary)');
            tbody.innerHTML += `<tr><td>${e.t}</td><td>${e.v}</td><td style="font-weight:800; color:${color}">${e.r}</td></tr>`;
        });
    }

    function confirmClear() {
        showModal('fas fa-trash-alt', 'Confirm', lang[currentLang].conf, 'var(--danger)', true);
        const actions = document.getElementById('modalActions');
        actions.firstChild.onclick = function() { db = []; localStorage.removeItem('SYP_V24_MASTER'); updateLog(); closeModal(); };
    }

    function exportCSV() {
        let csv = "\uFEFFDate,Value,Result\n";
        db.forEach(e => csv += `${e.t},${e.v},${e.r}\n`);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
        a.download = 'SYP_DR_HAIDAR_REPORT.csv'; a.click();
    }

    // Make functions globally accessible
    window.toggleLang = toggleLang;
    window.checkInputs = checkInputs;
    window.openTab = openTab;
    window.toggleTheme = toggleTheme;
    window.showModal = showModal;
    window.closeModal = closeModal;
    window.runCalc = runCalc;
    window.runBox = runBox;
    window.liveUpdate = liveUpdate;
    window.confirmClear = confirmClear;
    window.exportCSV = exportCSV;
    window.validateActivation = validateActivation;
    window.copyDID = copyDID;

    // Initialize on load
    window.onload = () => { checkStatus(); updateLog(); };
})();

// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
            .then(registration => {
                console.log('âœ“ PWA Service Worker registered:', registration.scope);
            })
            .catch(error => {
                console.error('âœ— Service Worker registration failed:', error);
            });
    });
}
</script>
</body>
</html>
